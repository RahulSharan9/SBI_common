import os
import pandas as pd

# Path to main output folder
output_dir = "output_folder"

# Columns to use different fill rate formula (1 - % null only)
exclude_zero_in_fill = ['col1', 'col2', 'col3']

all_data = []

# Step 1: Read all quarters and prepare master DataFrame
for quarter_folder in os.listdir(output_dir):
    quarter_path = os.path.join(output_dir, quarter_folder)
    if not os.path.isdir(quarter_path):
        continue

    data_quality_path = os.path.join(quarter_path, "data_quality")
    if not os.path.isdir(data_quality_path):
        print(f"No data_quality folder in {quarter_folder}, skipping.")
        continue

    csv_files = [f for f in os.listdir(data_quality_path) if f.endswith("_stats.csv")]
    if not csv_files:
        print(f"No stats CSV found in {data_quality_path}, skipping.")
        continue

    for csv_file in csv_files:
        csv_path = os.path.join(data_quality_path, csv_file)

        df = pd.read_csv(csv_path)

        # Standardize column names
        df.columns = df.columns.str.strip().str.lower().str.replace(' ', '_')

        # Ensure numeric columns are float
        for col in ['total_rows', 'null_counts', 'zero_counts']:
            if col in df.columns:
                df[col] = df[col].astype(float)
            else:
                df[col] = 0.0  # default 0 if column missing

        # Extract segment from file name (SEG1.parquet -> SEG1)
        df['segment'] = df['file'].str.replace('.parquet','', regex=False)

        # Compute % nulls and % zeros
        df['null_pct'] = df['null_counts'] / df['total_rows'] * 100
        df['zero_pct'] = df['zero_counts'] / df['total_rows'] * 100

        # Compute fill rate
        df['fill_rate_pct'] = 100 - df['null_pct'] - df['zero_pct']
        mask = df['column'].isin(exclude_zero_in_fill)
        df.loc[mask, 'fill_rate_pct'] = 100 - df.loc[mask, 'null_pct']

        # Keep relevant columns and quarter info
        df_quarter = df[['segment', 'column', 'null_pct', 'zero_pct', 'fill_rate_pct']].copy()
        df_quarter['Quarter'] = quarter_folder

        all_data.append(df_quarter)

# Step 2: Combine all quarters
master_df = pd.concat(all_data, ignore_index=True)

# Step 3: Group by segment + column for aggregations
grouped = master_df.groupby(['segment','column'])

# Aggregate min, max, avg
summary_df = grouped.agg(
    min_null_pct=('null_pct', 'min'),
    max_null_pct=('null_pct', 'max'),
    avg_null_pct=('null_pct', 'mean'),
    min_zero_pct=('zero_pct', 'min'),
    max_zero_pct=('zero_pct', 'max'),
    avg_zero_pct=('zero_pct', 'mean'),
    min_fill_rate_pct=('fill_rate_pct', 'min'),
    max_fill_rate_pct=('fill_rate_pct', 'max'),
    avg_fill_rate_pct=('fill_rate_pct', 'mean')
).reset_index()

# Step 4: Add corresponding quarter for each min/max value
def get_quarter_for_extreme(df, grouped, col):
    min_idx = grouped[col].idxmin()
    max_idx = grouped[col].idxmax()
    min_quarters = df.loc[min_idx.values, 'Quarter'].values
    max_quarters = df.loc[max_idx.values, 'Quarter'].values
    return min_quarters, max_quarters

# Null %
summary_df['min_null_quarter'], summary_df['max_null_quarter'] = get_quarter_for_extreme(master_df, grouped, 'null_pct')
# Zero %
summary_df['min_zero_quarter'], summary_df['max_zero_quarter'] = get_quarter_for_extreme(master_df, grouped, 'zero_pct')
# Fill Rate %
summary_df['min_fill_rate_quarter'], summary_df['max_fill_rate_quarter'] = get_quarter_for_extreme(master_df, grouped, 'fill_rate_pct')

# Round percentages
summary_df = summary_df.round(2)

# Save to CSV
summary_df.to_csv("segment_column_fillrate_trends_with_quarters.csv", index=False)

print("Segment-level null/zero/fill rate trend summary with quarters saved as 'segment_column_fillrate_trends_with_quarters.csv'")
